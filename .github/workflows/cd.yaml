name: Build and Push

on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - "v*.*.*"

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository with full history for tags
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # Extract version from git tag
      - name: Get Version
        id: version
        run: |
          # Get the latest git tag, default to v0.0.0 if none exists
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      # Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Build the Docker image with version tags
      - name: Build Docker Image
        run: |
          make docker-build

      # Tag the Docker image with version and latest tags
      - name: Tag Docker Image
        run: |
          docker tag goldilocks:dev ${{ secrets.DOCKER_USERNAME }}/goldilocks-custom:${{ steps.version.outputs.version }}
          docker tag goldilocks:dev ${{ secrets.DOCKER_USERNAME }}/goldilocks-custom:latest

      # Push the Docker image to Docker Hub
      - name: Push Docker Image
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/goldilocks-custom:${{ steps.version.outputs.version }}
          docker push ${{ secrets.DOCKER_USERNAME }}/goldilocks-custom:latest
